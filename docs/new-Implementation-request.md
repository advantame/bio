# 実装依頼書 — シンプルフロー再構築

## 0. 重要方針（アップデート）
- **シンプルモードがアプリ本体。** `/` アクセス時は常にシンプルフローを表示する。
- 画面構成は **4 ステップの横断フロー** に統一：
  1. **設計** — 仮説入力と修飾カード編集
  2. **即時予測** — 時系列波形・派生パラメータ・簡易比較
  3. **同定** — Fit / 滴定の適用とカード反映
  4. **比較** — 分岐図 / ヒートマップ / オーバーレイ管理
- 旧来の `/simulator` `/bifurcation` `/heatmap` `/workbench` は「ページ」ではなく、各ステップへ組み込む**ビュー**として再配置する。
- **詳細モードはレガシー互換ビュー**としてヘッダーから遷移できる別画面に残す。初回表示やデフォルトにはしない。

---

## 1. ルーティング再設計
- ルート構成：
  - `/simple/1` … 設計
  - `/simple/2` … 即時予測
  - `/simple/3` … 同定
  - `/simple/4` … 比較
  - `/detail` … 旧 Workbench UI（レガシー互換）
- 互換リダイレクト（深リンク維持）
  - `/workbench` → `/simple/1`
  - `/simulator` → `/simple/2?view=time`
  - `/bifurcation` → `/simple/4?view=bifurcation&…`
  - `/heatmap` → `/simple/4?view=heatmap&…`
  - `/workbench?mode=detail` → `/detail`
- URL 原則：
  - `active`, `overlays`, `preset`, `wbv` 等は従来どおりクエリで表現。
  - 不明なカード ID は警告表示のうえ無視。既知 ID はストアへマージ。

---

## 2. グローバルナビゲーションと情報設計
- すべてのシンプルステップは共通ヘッダーを持つ：
  - 左：アプリ名
  - 中央：進行ステッパー（①〜④、クリックで遷移）
  - 右：詳細（レガシー）切替、言語切替（将来拡張）
- 各ステップは自給自足のレイアウトと導線を備える：
  - **① 設計**：修飾カード編集、濃度↔比トグル、温度、ヘアピン、プリセット、メモ、派生のサマリー
  - **② 即時予測**：中央に時間波形（Simulator エンジン）、左に派生パネル、右にオーバーレイ選択と分岐/熱図 CTA
  - **③ 同定**：CSV ドロップ → Fit → 結果反映、滴定サブセクション
  - **④ 比較**：大型分岐図・ヒートマップ（タブ切り替え）、オーバーレイ管理、バインディング表、出力
- 視覚化エンジンは再利用：
  - `/web/simulator/` の描画ロジックは Step② に組み込む
  - `/web/bifurcation/` `/web/heatmap/` は Step④ のタブビューとして埋め込む

---

## 3. 状態・データ共有
- 単一ストア（修飾カード・active・overlays）は従来どおり `modifications.js` をベースにする。
- ステップ間のデータ循環：
  - ①の入力更新 → 派生値再計算 → ②/④ の表示を更新
  - ③の Fit / 滴定 → カードへ反映 → ②/④ へ再伝播
- アクティブ / オーバーレイは全ステップで共通の UI から編集可能。

---

## 4. 画面責務の再割り当て
| 旧ページ | 新ステップ | 役割 |
| --- | --- | --- |
| Workbench | ① 設計 | 修飾カード・濃度/比トグル・プリセット・メモ・派生概要 |
| Simulator | ② 即時予測 | 時間波形 + 派生パラメータ + 簡易比較 |
| （Fit） | ③ 同定 | Prey-only Fit と滴定を分離し必須フロー化 |
| Bifurcation | ④ 比較 | 分岐図、プリセット、オーバーレイ制御 |
| Heatmap | ④ 比較 | ヒートマップ、プリセット、出力 |

---

## 5. Simple（新） vs Detail（レガシー）
- **Simple**：標準体験。濃度入力を第一級に据え、比率への自動換算を表示。数式解説をページ下部に KaTeX で提供。
- **Detail**：旧 UI を保持。ステップ進捗・メモなど必要最小限の同期のみ実装。シンプルフローからいつでも戻れる。

---

## 6. 受け入れ基準（抜粋）
1. `/` アクセスで `/simple/1` に遷移し、ステッパーが①を選択状態で表示される。
2. ②で確認した派生・オーバーレイ設定が、③→④へ移動しても保持される。
3. ④の分岐図 / ヒートマップは ②で選択した active / overlays をデフォルトで反映する。
4. 旧 URL（例：`/bifurcation?preset=G_sweep&active=...`）にアクセスした場合、対応するシンプルステップへ案内し、クエリが反映される。
5. 詳細（レガシー）に切り替えてもカード・派生値・オーバーレイ状態が一致し、ステップに戻ると最新状態が表示される。
6. KaTeX ロード失敗時はプレーンテキスト式を表示し、警告をログ出力する。

---

## 7. 実装メモ
- ルーティング：`/simple/:stepId` をトップレベルに追加。旧ページ HTML はモジュール化してステップビューからインポートする。
- ステッパー CTA：右下固定の「戻る / 次へ」。必須入力未充足時は無効化し、理由をツールチップで表示。
- 深リンク CTA：②・④ から生成するリンクには `wbv=2`, `step`, `mode=simple` を付加。受け側で正規化する。
- テレメトリ：既存イベントに `mode`, `step` を付与。Simple/Detail 切替イベントを新設。
- テスト：回帰ハーネスに `node --experimental-fetch` を導入し、ステップ遷移と派生値整合性をチェックする。

---

## 8. 今後の資料
- `docs/workbench-simple-mode-plan.md` — フェーズ分解とタスク詳細
- `docs/specification.md` — Workbench セクションをシンプルフロー構成に合わせて更新予定
- `docs/modification-workbench-development-plan.md` — Milestone D を刷新予定（Simple フロー移行）

