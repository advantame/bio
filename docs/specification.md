# PP Oscillation Simulation — Technical Specification

## 1. Purpose and Scope
This document captures the current behaviour, interfaces, and runtime expectations of the DNA predator–prey oscillator simulation app. It covers the Rust/WebAssembly core, JavaScript wrappers, browser UI, build scripts, and supporting assets so that future contributors can maintain or extend the system without scanning each source file manually.

## 2. Architecture Overview
- **Languages**: Rust (simulation core), JavaScript/HTML/CSS (UI), WebAssembly for bridging.
- **Runtime**: All UIs are static single-page documents under `web/`; data processing occurs in the browser with WASM.
- **Entry points**:
  - `crate/src/lib.rs` exposes both legacy non-dimensional (`simulate`) and physical-parameter (`simulate_physical`) solvers through `wasm-bindgen`.
  - `web/core.js` provides an initialization + wrapper layer shared by all physical-parameter pages.
  - Page-specific modules (`web/simulator/`, `web/bifurcation/`, `web/heatmap/`) build UI controls and canvas renderers around the shared solver.

### 2.1 Data Flow
1. Page loads and calls `initWasm()` from `web/core.js`, which lazy-loads `web/pkg/pp_osc_wasm.js` and the compiled `.wasm` binary.
2. UI input values are collected into a parameter object.
3. `runSimulationPhysical(params)` forwards the values to `simulate_physical` and receives a `Float32Array` representing `[N_series..., P_series...]` in nM.
4. Page-specific rendering logic transforms the raw series into time plots, phase portraits, bifurcation envelopes, or heatmaps.
5. Status text and presets are managed entirely on the client; no server is required.

## 3. Simulation Core (`crate/src/lib.rs`)
### 3.1 Module Structure
- Exports are annotated with `#[wasm_bindgen]` so that `wasm-pack` generates JavaScript bindings.
- Internally uses `f64` for numerical integration and converts results to `f32` before returning to minimize payload sizes.

### 3.2 `simulate(...)`
- Legacy solver retained for backwards compatibility with the original non-dimensional MATLAB/Python tooling.
- Parameters: `beta`, `delta`, `lam`, `n0_nm`, `p0_nm`, `g_in` (all `f64`). Converts inputs to internal dimensionless variables and runs a fixed-step RK4 integrator over 2601 points.
- Output: Concatenated time series (`prey`, `predator`) as `Vec<f32>` where prey trace is transformed to `400 − n*Kmp` for legacy display parity.

### 3.3 `simulate_physical(...)`
- Implements SI Section S3 (Eq. 3–4) directly in physical units (minutes, nM).
- Parameters (all `f64`):
  - `pol`, `rec`: enzyme concentrations scaling synthesis and degradation.
  - `g`: template DNA concentration (`G`).
  - `k1`, `k2`: efficiencies for prey template extension and predator replication.
  - `k_n`, `k_p`: degradation rates for prey and predator.
  - `b`: saturation factor capturing template binding nonlinearity.
  - `km_p`: Michaelis constant for predator degradation.
  - `n0`, `p0`: initial concentrations.
- Modification cards (Workbench) expose association/polymerase/nicking ratios; the legacy `mod_factor` scalar is retained internally for compatibility but no longer user-facing.
  - `t_end_min`, `dt_min`: simulation horizon and fixed step (guarded to stay positive).
- Integration loop:
  1. Clamp `dt_min` to a minimum of 0.0 -> 1.0 fallback, convert to number of steps.
  2. Iterate with classical RK4 using helper `rhs_phys`, which computes:
     - `growth = k1_eff * pol * g * n / (1 + b * g * n)`
     - `predation = k2 * pol * n * p`
     - `deg_n = rec * k_n * n / (1 + p/km_p)`
     - `deg_p = rec * k_p * p / (1 + p/km_p)`
  3. Enforce non-negativity after each step.
  4. Accumulate `[N, P]` series in native units.
- Returns concatenated `[N_series..., P_series...]` as `Vec<f32>` which `wasm-bindgen` maps to `Float32Array` in JS.

## 4. WASM Packaging (`web/pkg/`)
- Generated by `wasm-pack build --target web`.
- `package.json` declares ESM entry (`pp_osc_wasm.js`) and TypeScript definitions (`pp_osc_wasm.d.ts`).
- Consumers must call the default `init` function (re-exported via `initWasm`) before invoking any exported simulation function.
- Memory management is handled by `wasm-bindgen`; callers do not free buffers manually.

## 5. Web Front-end
### 5.1 Shared Assets
- `web/index.html`: static redirect to `/simulator/`.
- `web/equation.png`: visual depiction of the SI differential equations displayed on the simulator page.
- Navigation component (Home, Simulator, Bifurcation, Heatmap) is duplicated across pages for consistency.

### 5.2 Legacy Non-dimensional UI (`web/app.js`)
- Targets the legacy `simulate` function.
- Provides sliders for `beta`, `delta`, `lam`, `N`, `P`, `G` and renders a single time-series canvas.
- Retained for historical comparison; not linked from the main navigation.

### 5.3 Physical-Parameter Simulator (`web/simulator/`)
- `index.html` defines layout: two canvases (time series, phase portrait), parameter panels, and explanatory copy.
- `simulator.js` responsibilities:
  - Binds paired range/number inputs for the 12 adjustable physical quantities (`pol`, `rec`, `G`, `k1`, `k2`, `kN`, `kP`, `b`, `KmP`, `N0`, `P0`, `t_end`, `dt`).
  - Applies Modification Workbench effects (association/polymerase/nicking/hairpin) on top of the base sliders before invoking the solver.
  - Renders baseline overlays and additional modification cards (from Workbench Simulate/Map) with distinct colors/dash patterns; status displays Δ amplitude/period summaries when baseline comparison is enabled.
  - Maintains defaults from SI Table S5 (`DEFAULTS` constant).
  - Uses `requestAnimationFrame` loop to coalesce updates; each frame requests data from `runSimulationPhysical` with current values.
  - Converts prey trace for the time-series plot: `Prey_display = 400 − N` (plots baseline-corrected fluorescence) while the phase plot uses raw `(N, P)`.
  - Renders axes with dynamic “nice” ticks, grid lines, legends, and performance status text (`calc+draw` timing and point count).
  - Shows a busy badge while simulation/drawing occurs.

### 5.4 Bifurcation Explorer (`web/bifurcation/`)
- Allows 1D parameter sweeps to capture predator maxima/minima after transients.
- `bifurcation.js`:
  - Collects base physical parameters plus sweep configuration (`param`, `pmin`, `pmax`, `steps`, `tail`, `t_end`, `dt`).
  - For each sweep sample, runs `runSimulationPhysical`, keeps only the trailing `tail%` of the predator series, and records min/max envelopes.
  - Animates via async loop with `await new Promise(r => setTimeout(r))` to keep the UI responsive.
  - Canvas renderer plots maxima/minima for each requested series (active, baseline overlay, additional overlays from Workbench) with unique colors/radii and a dynamic legend.
  - Preset “振動の誕生（G掃引）” seeds SI Fig. S11-like behaviour by resetting to SI defaults and scanning `G = 50…300`.

### 5.5 Parameter Heatmap (`web/heatmap/`)
- Executes a 2D grid sweep over two chosen parameters and evaluates either amplitude or period metrics on the predator series.
- `heatmap.js`:
  - Validates distinct X/Y parameters and builds an `nx × ny` grid (defaults: `G` vs `k1`).
  - For each cell, runs the solver with adjusted values, trims to trailing `tail%`, then:
    - `amplitude`: difference between max/min in the tail.
    - `period`: mean spacing (in minutes) between detected local maxima (simple three-point peak test) times `dt_min`.
  - Stores results in a `Float32Array` and renders the grid using the Turbo colormap with a side legend.
  - When Workbench analysis prefs enable a baseline, an additional grid is computed and a Δ (active − baseline) heatmap can be displayed; overlay cards report mean/min/max deltas vs the selected reference in the status footer.
  - Provides two presets: modulation vs `G` (period metric) and template vs degradation enzyme (amplitude metric).

### 5.6 Shared Helper Behaviour
- Axis scaling (`niceNum`, `niceAxis`) and canvas drawing patterns are duplicated between pages. Each module recomputes ticks from data extents to keep plots readable over a wide parameter range.
- Status elements report progress and timing to the user for transparency during heavy sweeps.

## 6. Parameter Defaults and Units
- Core SI S5 defaults: `pol=3.7`, `rec=32.5`, `G=150`, `k1=0.0020`, `k2=0.0031`, `kN=0.0210`, `kP=0.0047`, `b=0.000048`, `KmP=34`, `N0=10`, `P0=10` (Workbench cards start from an identity effect, equivalent to legacy `mod_factor=1.0`).
- Time window defaults: `t_end=2000–3000 min`, `dt=0.5–1.0 min`; tail windows usually 30–60% of the trajectory for steady-state metrics.
- Units are consistent across the system (minutes for time, nM for concentrations). Sliders/inputs enforce sensible ranges to avoid negative values, but final clamping occurs on the Rust side for `N`/`P` during integration.

## 7. Build and Deployment
- `netlify-build.sh` ensures Rust toolchain + `wasm-pack` are available, builds the WASM package in release mode, and copies the entire `web/` directory to `dist/` for publishing.
- `netlify.toml` configures Netlify to run the build script and serve from `dist/`; also forces the correct MIME type for `.wasm` files.
- GitHub Pages deployment is managed via workflow (`.github/workflows/deploy-pages.yml`, see docs) and requires `web/.nojekyll` to prevent asset stripping.

## 8. Documentation and Supporting Files
- `AGENTS.md`: high-level onboarding memo for new agents (mirrors the summary in this specification).
- `docs/plan.md`: original development roadmap describing the shift to physical parameters and planned UI pages.
- `docs/Supplementary Information.md`: full paper supplement retained locally for parameter provenance (ignored by Git).
- `web/equation.png`: referenced on the simulator page to show the governing equations.

## 9. Known Limitations and Extension Points
- Current amino-acid modelling derives effective `k1`, `b`, `G`, `β` via Workbench ratios (`r_assoc`, `r_poly`, `r_nick`, hairpin correction). The simple scalar `mod_factor` remains in the WASM API for backward compatibility but is no longer exposed in the UI.
- Numeric stability relies on manually chosen `dt_min`. Extremely small or large time steps may still produce artefacts; adaptive solvers are not implemented.
- Canvas rendering code is duplicated across pages; extracting shared utilities or a lightweight plotting helper would reduce maintenance.
- Period detection in heatmaps uses a naive peak finder and may mis-estimate noisy signals; consider more robust peak detection or smoothing for future work.

## 10. Usage Checklist for Contributors
1. Modify Rust ODEs in `crate/src/lib.rs`, then rebuild with `wasm-pack` to refresh `web/pkg/`.
2. Keep UI parameter lists in sync with the Rust signature; `runSimulationPhysical` expects positional arguments.
3. When adding new pages, import `initWasm` and `runSimulationPhysical` from `web/core.js` to reuse the initialization workflow.
4. Update presets and documentation when changing default parameter values to match experimental baselines.
5. Run a local static server (`python3 -m http.server --directory web 8080`) to test pages before deployment.
