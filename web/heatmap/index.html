<!doctype html>
<meta charset="utf-8">
<title>2Dパラメータ・ヒートマップ — PP-oscillation</title>
<style>
  :root { --line:#e5e7eb; --muted:#666; }
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin:16px; background:#fafafa; }
  .wrap { display:flex; flex-direction:column; gap:16px; }
  .card { background:#fff; border:1px solid var(--line); border-radius:12px; padding:14px; box-shadow:0 1px 2px rgba(0,0,0,.03); }
  .note { color:var(--muted); font-size:.92rem; line-height:1.6; margin-top:8px; }
  canvas { background:#fff; border:1px solid var(--line); border-radius:10px; width:100%; height:520px; }
  .rows { display:grid; grid-template-columns: 160px 1fr 120px; gap:10px 10px; align-items:center; }
  .row { display:contents; }
  input[type="number"], select { width:100%; box-sizing:border-box; }
  input[type="number"]:disabled, select:disabled { background:#f5f5f5; color:#999; cursor:not-allowed; }
  .buttons { display:flex; gap:10px; margin-top:12px; }
  button { padding:8px 12px; border-radius:8px; border:1px solid #d1d5db; background:#f8f8f8; cursor:pointer; }
  button:hover { background:#f0f0f0; }
  .section { border:1px solid #e5e7eb; border-radius:8px; padding:14px; margin-bottom:12px; background:#fafafa; }
  .section-title { font-size:1.05rem; font-weight:600; margin:0 0 10px; color:#374151; }
  .param-group { display:grid; grid-template-columns: 160px 1fr; gap:10px 10px; align-items:center; margin-top:10px; }
  .nav { display:flex; gap:12px; flex-wrap:wrap; padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; }
  .nav a { color:#2563eb; text-decoration:none; }
  .nav a:hover { text-decoration:underline; }
</style>

<div class="wrap">
  <div class="nav">
    <a href="../">Home</a>
    <span>·</span>
    <a href="../simulator/">Simulator</a>
    <span>·</span>
    <a href="../bifurcation/">Bifurcation</a>
    <span>·</span>
    <a href="../heatmap/">Heatmap</a>
    <span>·</span>
    <a href="../workbench/">Modification Workbench</a>
  </div>

  <div class="card">
    <h2 style="margin:4px 0 10px;">2Dパラメータ・ヒートマップ</h2>
    <div style="display:flex; gap:16px; flex-wrap:wrap;">
      <div style="flex:2 1 520px; min-width:420px;">
        <canvas id="cv" width="1200" height="560"></canvas>
        <video id="videoPlayer" controls style="display:none; width:100%; max-height:560px; border:1px solid var(--line); border-radius:10px; margin-top:12px;"></video>
        <div id="status" class="note"></div>
        <div class="note" style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
          表示:
          <select id="variantSelect" style="width:auto; min-width:200px;"></select>
        </div>
      </div>
      <div class="card" style="flex:1 1 360px; min-width:320px;">
        <!-- プリセット選択 -->
        <div class="section">
          <h3 class="section-title">📋 プリセット</h3>
          <div style="display:flex; gap:8px; align-items:center;">
            <select id="preset" style="flex:1;">
              <option value="none">選択してください</option>
              <option value="mod_assoc">アミノ酸修飾の影響（周期）</option>
              <option value="balance">酵素バランスと安定性（振幅）</option>
            </select>
            <button id="applyPreset">適用</button>
          </div>
          <div id="presetDesc" class="note" style="margin-top:8px;"></div>
        </div>

        <!-- ヒートマップ設定 -->
        <div class="section">
          <h3 class="section-title">📊 ヒートマップ設定</h3>

          <div class="param-group">
            <label for="xParam"><strong>X軸パラメータ</strong></label>
            <select id="xParam">
              <option value="G">G (鋳型濃度)</option>
              <option value="k1">k₁ (会合速度定数)</option>
              <option value="assoc_ddg">ΔΔG_assoc (自由エネルギー差)</option>
              <option value="assoc_r">r_assoc (会合比)</option>
              <option value="poly_r">r_poly (ターンオーバー倍率)</option>
              <option value="nick_r">r_nick (飽和倍率)</option>
              <option value="pol">pol (ポリメラーゼ濃度)</option>
              <option value="rec">rec (分解酵素濃度)</option>
              <option value="KmP">KmP (ミカエリス定数)</option>
              <option value="N0">N₀ (初期prey濃度)</option>
              <option value="P0">P₀ (初期predator濃度)</option>
            </select>
            <label for="xMin">　最小値</label>
            <input id="xMin" type="number" step="0.01" value="50">
            <label for="xMax">　最大値</label>
            <input id="xMax" type="number" step="0.01" value="300">
            <label for="xSteps">　分割数</label>
            <input id="xSteps" type="number" step="1" value="40">
          </div>

          <div class="param-group" style="margin-top:16px;">
            <label for="yParam"><strong>Y軸パラメータ</strong></label>
            <select id="yParam">
              <option value="k1">k₁ (会合速度定数)</option>
              <option value="G">G (鋳型濃度)</option>
              <option value="assoc_ddg">ΔΔG_assoc (自由エネルギー差)</option>
              <option value="assoc_r">r_assoc (会合比)</option>
              <option value="poly_r">r_poly (ターンオーバー倍率)</option>
              <option value="nick_r">r_nick (飽和倍率)</option>
              <option value="pol">pol (ポリメラーゼ濃度)</option>
              <option value="rec">rec (分解酵素濃度)</option>
              <option value="KmP">KmP (ミカエリス定数)</option>
              <option value="N0">N₀ (初期prey濃度)</option>
              <option value="P0">P₀ (初期predator濃度)</option>
            </select>
            <label for="yMin">　最小値</label>
            <input id="yMin" type="number" step="0.01" value="0.2">
            <label for="yMax">　最大値</label>
            <input id="yMax" type="number" step="0.01" value="1.5">
            <label for="ySteps">　分割数</label>
            <input id="ySteps" type="number" step="1" value="30">
          </div>

          <div class="param-group" style="margin-top:16px;">
            <label for="metric"><strong>評価指標</strong></label>
            <select id="metric">
              <option value="amplitude">振幅 (max-min) [nM]</option>
              <option value="period">周期 (ピーク間平均) [min]</option>
            </select>
            <label for="tail">評価区間 (末尾%)</label>
            <input id="tail" type="number" step="1" value="30">
            <label for="t_end">シミュレーション時間 [min]</label>
            <input id="t_end" type="number" step="100" value="2600">
            <label for="dt">時間刻み幅 [min]</label>
            <input id="dt" type="number" step="0.1" value="1">
          </div>

          <div class="param-group" style="margin-top:16px; border-top:1px solid #e5e7eb; padding-top:12px;">
            <label for="enableTimeAxis"><strong>時間軸動画生成</strong></label>
            <input id="enableTimeAxis" type="checkbox">
            <label for="tMin">　開始時刻 [min]</label>
            <input id="tMin" type="number" step="10" value="0" disabled>
            <label for="tMax">　終了時刻 [min]</label>
            <input id="tMax" type="number" step="10" value="2600" disabled>
            <label for="tSteps">　フレーム数</label>
            <input id="tSteps" type="number" step="1" value="50" disabled>
          </div>
        </div>

        <!-- ベースパラメータ -->
        <div class="section">
          <h3 class="section-title">⚙️ ベースパラメータ（固定値）</h3>
          <div class="param-group">
            <label for="pol">pol [nM]</label>
            <input id="pol" type="number" step="0.01" value="3.7">
            <label for="rec">rec [nM]</label>
            <input id="rec" type="number" step="0.01" value="32.5">
            <label for="G">G [nM]</label>
            <input id="G" type="number" step="1" value="150">
            <label for="k1">k₁ [nM⁻¹min⁻¹]</label>
            <input id="k1" type="number" step="0.0001" value="0.0020">
            <label for="k2">k₂ [min⁻¹]</label>
            <input id="k2" type="number" step="0.0001" value="0.0031">
            <label for="kN">kN [min⁻¹]</label>
            <input id="kN" type="number" step="0.001" value="0.0210">
            <label for="kP">kP [min⁻¹]</label>
            <input id="kP" type="number" step="0.0001" value="0.0047">
            <label for="b">b [nM⁻¹]</label>
            <input id="b" type="number" step="0.000001" value="0.000048">
            <label for="KmP">KmP [nM]</label>
            <input id="KmP" type="number" step="1" value="34">
            <label for="N0">N₀ [nM]</label>
            <input id="N0" type="number" step="0.1" value="10">
            <label for="P0">P₀ [nM]</label>
            <input id="P0" type="number" step="0.1" value="10">
          </div>
        </div>

        <div class="buttons">
          <button id="runBtn">🚀 ヒートマップを生成</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 説明セクション -->
  <div class="card" style="margin-top:8px;">
    <h3 style="margin:0 0 8px;">ページ3: 2Dパラメータ・ヒートマップ</h3>
    <h4 style="margin:0 0 6px;">このツールについて</h4>
    <p>
      このツールは、2つの異なるパラメータを同時に変化させたときに、振動の<strong>周期（波長）や振幅</strong>といった特性がどのように変化するかを<strong>ヒートマップ</strong>として可視化する、最も高度な分析ツールです。
    </p>
    <p>
      例えば、横軸に鋳型DNA濃度 <code>G</code>、縦軸にアミノ酸修飾による自由エネルギー差 <code>ΔΔG<sub>assoc</sub></code> を設定すると、修飾強度と鋳型濃度の組み合わせごとに振動周期がどう変化するかを色で俯瞰できます。
    </p>
    <p>
      <strong>🎬 時間軸動画生成機能:</strong> 「時間軸動画生成」をONにすると、X-Yパラメータ空間での<strong>時系列変化</strong>を動画として生成できます。各グリッドポイントで時系列シミュレーションを実行し、指定した時間範囲でのヒートマップの変化を動画で確認できます。例えば、N濃度の時間変化をパラメータ空間全体で可視化することで、振動の開始タイミングや位相のずれなどを直感的に理解できます。
    </p>
    <p>
      <em>文脈:</em> あなたの最終目標は「DNAへのアミノ酸結合が振動の波長をどう変えるか」を明らかにすることです。このツールはその問いに最も直接的に答えるためのものです。このヒートマップを使えば、「アミノ酸修補飾効果(<code>k₁</code>の低下)は、<code>G</code>濃度が低い領域では周期をわずかに伸ばすだけだが、<code>G</code>濃度が高い領域では周期を劇的に変化させる」といった、<strong>パラメータ間の複雑な相互作用</strong>を明らかにすることができます。これにより、シミュレーションから「xxという条件下でyyという結果が得られるはずだ」という、実験的に検証可能な<strong>具体的な仮説</strong>を生み出すことが可能になります。
    </p>
  </div>
</div>

<script type="module" src="./heatmap.js"></script>
